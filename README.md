## taskwatcher

#### DESCRIPTION

**'taskwatcher'** is a set of commands to turn scripts/programs into **tasks** :

- **launch.py**  : Starts a new task under taskwatcher monitoring
- **control.py** : General control commands

An **history** of the terminated tasks is kept.  
A **status** of the currently running tasks is available.

Tasks are **monitored** by checking if pid is still in process list.
Optionally, if feedback is provided by the launched program, program is expected to provide *heartbeat* by updating the feedback file.  

An optional **task timeout** may terminated the task if no hearbeat was received during the allowed 'timeout' period. 


###### Limitations

- Currently only supports mono-process program (track a single pid)


#### Design

Choice was made to avoid complex sockets operations.
Simple design with feedback files also allows simple state recovery, simplicity and versatility of the feedback parameters.
A basic file-based sqlite database is used to store running tasks data and keep track of historical tasks, instead of implementing a daemon.


#### Configuration

- Currently no configuration file is implemented. All options should be provided using cli options.
- No centralized daemon: 
	- a launcher is started with the program to run
	- getting feeback from the running task can be done by calling control.py with command 'feedback'
	- history and current status of running tasks are located in sqlite db


#### Expectation from the launched command

A command may be ran without specific requirement, however to benefit from additional features, the run command may provide feedback via a text file.  

The suggestion is to add to programs launched with taskwatcher a command line option to generate the **feedback.log** file, example :  

- Without taskwatcher :  
	`checkitbaby.py --playbook myPlaybook --playlist myPlaylist --run 1 --dryrun`
- With taskwatcher :  
	`launcher.py --taskid 1 --name 'Runner' --feedpath /fortipoc/playbooks/myPlaybook/run/1 --dbpath /fortipoc/taskwatch --timeout 30 --command 'checkitbaby.py --playbook myPlaybook --playlist myPlaylist --run 1 --dryrun'`



##### Running task status

- **without feedback :**
	- **running**    : pid of the task is seen

- **with feedback :** 

	- **running**    : pid of the task is seen,  
		               last feedback file update was done in less than 25% of timeout timer
	
	- **silent**     : pid of the task is seen,  
		               last feedback file update was done in less than 50% of timeout timer
 
	- **stalled**    : pid of the task is seen,  
	                   last feedback file update was done in less than 75% of timeout timer

###### Feedback file syntax

The feedback file is named 'feedback.log', it should be generated by the launched program.
Any kind of usefull information could be delivered as long as :
- it is key/value pair
- line starts with a keywork emcompassed with [] to specify the information keyword.
- keyword should have no spaces and should not start with a digit
- value provided should immediately follow the [keyword] without spaces
- line starting with # are considered comments/debug and will be ignored
- empty lignes will be ignored
- a keyword without any value on a line clears the keyword and value information from the feedback
- [] (without keyword) clears all key/value pairs collected up to this point.
  Note : this could be usefull to end the task with a clear followed by a report.


###### Feedback file processing

- launcher.py does not parse feedback file. It only checks the file update from the file update time for the task timeout fonction.
- control.py processed feedback file to provide output.  
  The last read value for a keyword updates any precedent values.  

- Example of a feedback.log
~~~
[info]Starting test
[playbook]myPlaybook
[info]
[heartbeat]
[testcase_id]001
[testcase_name]Initialization
[progress]12
[progress]15
[testcase_id]002
[testcase_name]Setting up topology
[progress]10
~~~

- If processed until this point, the above output would provide information like:
```json
{ 
  "playbook"      : "myPlaybook",
  "testcase_id"   : "002",
  "testcase_name" : "Setting up topology",
  "progress"      : "10"
}
```
Notes :  
- 'info' is not provided because it was cleared by the '[info]' line in line 3
- 'heartbeat' has no information, it would only reset the 'timeout' counter


#### launch.py

```tex
Roles : 
   - launches command
   - monitor the command checking its pid in process list
   - monitor activity of the feedback file (by its update timing information)
   - kills command if not updating feedback file within the timeout 
   - update the running task db about process state, duration and timer status

Usage : launch.py --dbpath <path> --taskid <taskid> `--command '<process or script with all its options>'

Parameters :
--dbpath   <path>         : path where sqlite db file is located
--taskid   <taskid>       : task identifier (could be a number or a generated random string (8 chars max)    

Optional parameters :  
--name     <name>         : Name for the task. Use command name if not provided
--feedpath <path>         : Feedback path where feedback.log is expected
--timeout  <seconds>      : a value in second after which the command is considered timeout
				            and should be kill (any update in feedback.log resets the timer)
```

#### control.py

```tex
Roles :
   - Provide list of all running tasks with their latests status
   - Provide history of terminated tasks
   - Provide all latests feedback information from the task
   - Manage history
   - Kill tasks
   - Initialise (or re-initialize db)
   
Usage : control.py --dbpath <path> <command>

Options :
--dbpath <path>      : Path where db files is located

List of available commands :

--initialize         : Create or recreates a task database (all info is lost)

--list               : Provides a table displaying the list of the currently running tasks with : 
                       [ taskid, name, pid, status, starttime, duration(s), feedback(yes/no), timer(s), timeout(s) ]

--feedback <taskid>  : Returns a json formatted output of the feedback values for the given task
                     : Only available if the command provides feedback (feedback=yes in list)

--history            : Dump all historical tasks completed
--clear              : Clear all tasks history

--kill <taskid>      : Request to terminate a specific task
--killall <taskname> : Request to terminate all tasks named <taskname>

```

#### sqlite database

An sqlite database is used for 3 purposes :

- keep track of the current running tasks :  
  Launcher.py updates tasks status but does not process feedback

- keep track of the latest feedback from the launched command  
  control.py called with --feedback parses command feedback file, stores information and returns a json object

- keep an history of the previously completed tasks  
  control.py called with --history

Database file name is 'sqlite.db'


**Table format**

```tex
* Table tasks:
  Keeps track of running tasks status
  --------------------------------------------------------------------------------------------------------------------------------------------
  |       id(#0)        |  taskid(#1)  | taskname |    pid   |   status   |   feedback    |   startime   | duration |  lastupdate  | timeout |
  | INTEGER PRIMARY KEY |    TEXT      |   TEXT   |  INTEGER |  TEXT(#2)  |  INTEGER(#3)  |  INTEGER(#4) | INTEGER  |  INTEGER(#4) | INTEGER |
  --------------------------------------------------------------------------------------------------------------------------------------------

  Note : 
    #0 : should be automatic (use 'null' during insert)
    #1 : taskid should be uniq, for instance, use a random string generator
    #2 : RUNNING|SILENT|STALLED
    #3 : 0 if no feedback provided ; 1 if feedback provided
    #4 : unix format (seconds since ...)


* Table feedback:
  Keeps track of data feeback from the run command, stored as json key/value pairs
  ------------------
  |    id   | json |
  | INTEGER | BLOB |
  ------------------

* Table history:
  Keeps track of the completed tasks
  Final state of json feedback is stored (this allows to store json reports before the command terminates)
  --------------------------------------------------------------------------------------------------------------------------
  |       id(#0)        |  taskid(#1)  | taskname | termsignal | termerror |   startime   |   endtime   | duration |  json | 
  | INTEGER PRIMARY KEY |    TEXT      |   TEXT   |  TEXT(#1)  |  TEXT(#2) |  INTEGER(#4) | INTEGER(#4) | INTEGER  |  BLOB |
  --------------------------------------------------------------------------------------------------------------------------

  Note :
    #1: keeps track of the type of termination signal
	#2: keeps track of the terminaison error message if any
```



